# Database Migration Guide

Your Cloud SQL instance is protected by a private IP configuration, which means you cannot connect to it directly from your local machine unless you are connected to the VPC (e.g., via VPN) or use a proxy.

The `init-db.sql` script MUST be executed to enable the `vector` extension, otherwise the RAG functionality will fail.

## Option 1: Using Cloud Shell (Easiest)

1.  Upload `init-db.sql` to your Cloud Shell.
2.  Connect to the database using the private IP (if Cloud Shell is configured for VPC access) or use the Auth Proxy.

### Using Cloud SQL Auth Proxy in Cloud Shell

1.  Enable the API:

    ```bash
    gcloud services enable sqladmin.googleapis.com
    ```

2.  Start the proxy (background):

    ```bash
    ./cloud_sql_proxy -instances=<PROJECT_ID>:<REGION>:<INSTANCE_NAME>=tcp:5432 &
    ```

3.  Run the script:
    ```bash
    psql "host=127.0.0.1 port=5432 sslmode=disable user=postgres dbname=postgres" -f init-db.sql
    ```
    _(You will need the password generated by Terraform. Check Secret Manager: `projects/<PROJECT_ID>/secrets/<PROJECT_ID>-cloudsql-password`)_

## Option 2: Using a Temporary VM (Bastion Host)

1.  Create a small VM in the same VPC (`<project-id>-vpc`) and Subnet as the database.
2.  SSH into the VM.
3.  Install the postgres client:
    ```bash
    sudo apt-get update && sudo apt-get install -y postgresql-client
    ```
4.  Upload or copy-paste `init-db.sql`.
5.  Connect and run:
    ```bash
    psql -h <DB_PRIVATE_IP> -U postgres -d postgres -f init-db.sql
    ```

## Verification

To verify the extension is installed, log into the database and run:

```sql
SELECT * FROM pg_extension WHERE extname = 'vector';
```
